package com.hereliesaz.blusnu.correlator

import android.content.Context
import com.hereliesaz.blusnu.data.TargetDevice
import org.json.JSONArray
import org.json.JSONObject

data class Vulnerability(val name: String, val uuid: String, val description: String)

class VulnerabilityCorrelator(private val context: Context) {

    private val vulnerabilities: List<Vulnerability> by lazy {
        loadVulnerabilities()
    }

    private fun loadVulnerabilities(): List<Vulnerability> {
        val jsonString = context.assets.open("vulnerabilities.json").bufferedReader().use { it.readText() }
        val jsonArray = JSONArray(jsonString)
        val result = mutableListOf<Vulnerability>()
        for (i in 0 until jsonArray.length()) {
            val jsonObject = jsonArray.getJSONObject(i)
            result.add(
                Vulnerability(
                    name = jsonObject.getString("name"),
                    uuid = jsonObject.getString("uuid"),
                    description = jsonObject.getString("vulnerability")
                )
            )
        }
        return result
    }

    fun correlate(device: TargetDevice): List<Vulnerability> {
        return vulnerabilities.filter { vulnerability ->
            device.services.any { service -> service.equals(vulnerability.uuid, ignoreCase = true) }
        }
    }
}